<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MVP · OCR de Etiquetas</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #0f1115; color: #e8eaf0; }
    .app { max-width: 900px; }
    video { width: 100%; border-radius: 12px; background: #000; }
    canvas { display: none; }
    .btn-primary { background: #7a7617; border-color: #7a7617; }
    .btn-primary:hover { background: #686316; border-color: #686316; }
    .progress { height: 8px; border-radius: 999px; }
    .brand { font-weight: 700; letter-spacing: .5px; }
    .ghost { opacity:.75 }
  </style>
</head>
<body>
  <main class="container py-4 app">
    <header class="mb-4 d-flex align-items-center gap-2">
      <span class="brand">📷 OCR de Etiquetas (MVP)</span>
      <span class="ghost">· Web</span>
    </header>

    <div class="alert alert-secondary py-2 small" id="ocrLoading">
      Cargando motor OCR (spa+eng)… <span id="ocrLoadPct">0%</span>
    </div>

    <!-- Vista de cámara -->
    <div class="mb-3">
      <video id="video" playsinline autoplay muted></video>
      <canvas id="canvas"></canvas>
    </div>

    <div class="d-flex flex-wrap gap-2 mb-3">
      <button id="btnStart" class="btn btn-primary">🔓 Permitir cámara</button>
      <button id="btnCapture" class="btn btn-outline-light" disabled>📸 Capturar & OCR</button>
      <button id="btnStop" class="btn btn-outline-light" disabled>🛑 Parar cámara</button>
      <label class="btn btn-outline-light mb-0">
        📁 Subir foto
        <input id="fileInput" type="file" accept="image/*" capture="environment" hidden>
      </label>
    </div>

    <div id="ocrProgressWrap" class="progress d-none mb-3">
      <div id="ocrProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
    </div>

    <p class="small text-secondary">Consejo: encuadra solo la etiqueta, evita brillos y usa la linterna si tu navegador lo permite.</p>

    <!-- Modal resultado -->
    <div class="modal fade" id="resultadoModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title">Texto detectado</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <pre id="textoDetectado" class="mb-0" style="white-space: pre-wrap; word-break: break-word;"></pre>
          </div>
          <div class="modal-footer">
            <button id="btnCopiar" type="button" class="btn btn-primary">Copiar</button>
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Tesseract.js v5 -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js" crossorigin="anonymous"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const btnStart = document.getElementById('btnStart');
    const btnCapture = document.getElementById('btnCapture');
    const btnStop = document.getElementById('btnStop');
    const fileInput = document.getElementById('fileInput');
    const ocrProgressWrap = document.getElementById('ocrProgressWrap');
    const ocrProgressBar = document.getElementById('ocrProgressBar');
    const textoDetectado = document.getElementById('textoDetectado');
    const ocrLoading = document.getElementById('ocrLoading');
    const ocrLoadPct = document.getElementById('ocrLoadPct');

    let stream = null;
    let worker = null;

    const showProgress = (p) => {
      ocrProgressWrap.classList.remove('d-none');
      const pct = Math.round((p || 0) * 100);
      ocrProgressBar.style.width = pct + '%';
      ocrProgressBar.textContent = pct + '%';
    };
    const hideProgress = () => {
      ocrProgressWrap.classList.add('d-none');
      ocrProgressBar.style.width = '0%';
      ocrProgressBar.textContent = '';
    };

    const norm = (s) => s
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[\t\r]+/g, ' ')
      .replace(/\s{2,}/g, ' ')
      .trim();

let ocrInitPromise = null;

async function buildWorker(langPath, corePath) {
  const workerPath = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js';
  return Tesseract.createWorker({
    workerPath,
    corePath,
    langPath,
    logger: (m) => {
      if (m.status && typeof m.progress === 'number') {
        if (ocrLoading && (m.status.includes('loading') || m.status.includes('initializing'))) {
          ocrLoadPct.textContent = Math.round(m.progress * 100) + '%';
        }
        if (m.status === 'recognizing text') {
          showProgress(m.progress);
        }
      }
    }
  });
}

async function initOCR() {
  // Evita projectnaptha primero (adblock/CORS); usa jsDelivr
  const coreBase = 'https://cdn.jsdelivr.net/npm/tesseract.js-core@5.0.0/dist/';
  const corePath = (self.crossOriginIsolated)
    ? coreBase + 'tesseract-core-simd.wasm.js'
    : coreBase + 'tesseract-core.wasm.js';

  const langPaths = [
    'https://cdn.jsdelivr.net/npm/tessdata@4.0.0',   // <— PRIORIDAD 1 (jsDelivr)
    'https://tessdata.projectnaptha.com/5.0.0',      // fallback
    'https://tessdata.projectnaptha.com/4.0.0'       // fallback
  ];

  for (const lp of langPaths) {
    try {
      worker = await buildWorker(lp, corePath);
      try {
        await worker.loadLanguage('spa+eng');
        await worker.initialize('spa+eng');
      } catch (e) {
        console.warn('spa+eng falló, probando spa/eng. langPath=', lp, e);
        try {
          await worker.loadLanguage('spa'); await worker.initialize('spa');
        } catch {
          await worker.loadLanguage('eng'); await worker.initialize('eng');
        }
      }
      if (ocrLoading) ocrLoading.remove();
      return; // listo
    } catch (e) {
      console.warn('Fallo creando/cargando worker con langPath', lp, e);
      try { await worker?.terminate(); } catch {}
      worker = null;
    }
  }
  throw new Error('No se pudo cargar Tesseract (lang data). Revisa red/CORS.');
}

async function ensureOCRReady() {
  if (worker) return;
  if (!ocrInitPromise) {
    ocrInitPromise = initOCR().catch(err => {
      ocrInitPromise = null; // permite reintentar
      throw err;
    });
  }
  await ocrInitPromise;
}


async function startCamera() {
  if (!navigator.mediaDevices?.getUserMedia) {
    alert('Tu navegador no permite acceso a la cámara. Usa la opción "Subir foto".');
    return;
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        btnCapture.disabled = false;
        btnStop.disabled = true; // lo habilitamos tras play estable
        // A veces el video tarda en estar listo
        video.onloadedmetadata = () => { btnStop.disabled = false; };
      } catch (err) {
        console.error(err);
        alert('No se pudo acceder a la cámara. Revisa permisos y HTTPS.');
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      btnCapture.disabled = true;
      btnStop.disabled = true;
    }

    function captureBlobFromVideo() {
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      return new Promise((resolve) => {
        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.92);
      });
    }

async function doOCRFromBlob(blob) {
  // Intenta worker “bien” primero
  try {
    await ensureOCRReady();
    showProgress(0);
    const { data: { text } } = await worker.recognize(blob);
    hideProgress();
    const limpio = norm(text);
    textoDetectado.textContent = limpio || '(sin texto)';
    const modal = new bootstrap.Modal(document.getElementById('resultadoModal'));
    modal.show();
    return;
  } catch (e) {
    console.warn('Fallo OCR con worker, intento simple sin worker…', e);
  }

  // Fallback simple SIN worker (más lento, pero te saca del paso hoy)
  try {
    showProgress(0);
    const { data: { text } } = await Tesseract.recognize(
      blob,
      'spa+eng',
      {
        logger: (m) => {
          if (m.status === 'recognizing text' && typeof m.progress === 'number') {
            showProgress(m.progress);
          }
        },
        langPath: 'https://cdn.jsdelivr.net/npm/tessdata@4.0.0' // usa el mismo CDN robusto
      }
    );
    hideProgress();
    const limpio = norm(text);
    textoDetectado.textContent = limpio || '(sin texto)';
    const modal = new bootstrap.Modal(document.getElementById('resultadoModal'));
    modal.show();
  } catch (e2) {
    hideProgress();
    console.error(e2);
    alert('No se pudo cargar el motor OCR. Abre la consola del navegador para ver el error exacto (CORS/red).');
  }
}

    // Eventos
    btnStart.addEventListener('click', startCamera);
    btnStop.addEventListener('click', stopCamera);
    btnCapture.addEventListener('click', async () => {
      try {
        const blob = await captureBlobFromVideo();
        await doOCRFromBlob(blob);
      } catch (e) {
        console.error(e);
        alert('No se pudo capturar/leer la imagen.');
      }
    });

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      await doOCRFromBlob(file);
      fileInput.value = '';
    });

    document.getElementById('btnCopiar').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(textoDetectado.textContent || '');
        const btn = document.getElementById('btnCopiar');
        const original = btn.textContent;
        btn.textContent = '¡Copiado!';
        setTimeout(()=> btn.textContent = original, 1200);
      } catch (e) { alert('No se pudo copiar al portapapeles.'); }
    });

// Precarga (opcional). Si tarda, ensureOCRReady() cubrirá al pulsar el botón.
(async () => {
  try { await initOCR(); } catch (e) { console.warn('Preload OCR falló, se reintentará al usar.', e); }
})();

    
  </script>
</body>
</html>
